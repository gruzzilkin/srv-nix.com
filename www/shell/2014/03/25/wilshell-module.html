<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="google-site-verification" content="zrEDTiP0xgJYfIhexhD8C_CBtEQQrJa1fnOmXrzyhVM" />
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Пишем свой модуль для wilshell, краткое HOWTO</title>
    <meta name="viewport" content="width=device-width">
    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
<div class="b-canvas">
    <nav class="b-menu b-menu_type_inline b-menu_viewtype_square-brackets">
        <ul class="b-menu__list">
            <li class="b-menu__item"><a href="/" class="b-menu__item-text b-link"><span class="b-link__text">SRV-NIX.COM</span></a></li>
            <li class="b-menu__item"><a href="http://srv-nix.com/tags.html" class="b-menu__item-text b-link"><span class="b-link__text">Tags</span></a></li>
            <li class="b-menu__item"><a href="https://www.google.ru/search?q=google.com&oq=google.com&#newwindow=1&q=site:srv-nix.com" target="_blank" class="b-menu__item-text b-link"><span class="b-link__text">Search</span></a></li>
        </ul>
    </nav>

  <article class="b-document">
      <header class="b-document-header">
    <div class="b-document-header__section">
        Authtor:<br/>
        Posted at:<br/>
    </div>
    <div class="b-document-header__section">
        A. Semenov<br/>
        25 Mar 2014<br/>
    </div>
</header>
<dl class="b-document-section">
    <dt class="b-document-section__title">
        NAME
    </dt>
    <dd class="b-document-section__body b-pure-content">
                <h1>Пишем свой модуль для wilshell, краткое HOWTO</h1>
    </dd>
</dl>
<dl class="b-document-section">
    <dt class="b-document-section__title">
        Description
    </dt>
    <dd class="b-document-section__body b-pure-content">
        <div class="b-document-body">
            <div class="b-pure-content">
                <section>
                    <!--more-->

<p>Блок определений:</p>

<div class="highlight"><pre><code class="bash"><span class="nv">NAME</span><span class="o">=</span><span class="s1">&#39;default&#39;</span>
<span class="nv">AUTHOR</span><span class="o">=</span><span class="s1">&#39;wilful&#39;</span>
<span class="nv">DESCRIPTION</span><span class="o">=</span><span class="s1">&#39;An example of module configuration&#39;</span>
<span class="nv">USAGE</span><span class="o">=</span><span class="s1">&#39;-a  Первый ключ, флаг запуска</span>
<span class="s1">Можно поставить </span>
<span class="s1">    табы или например \n перенос строки</span>
<span class="s1">-b  Второй ключ, значение для запуска&#39;</span>
<span class="nv">MODULE_DEPENDS</span><span class="o">=(</span> <span class="s1">&#39;lock&#39;</span> <span class="o">)</span>
</code></pre></div>

<div class="highlight"><pre><code class="text language-text" data-lang="text">NAME - имя модуля, на основании этой переменной строятся внутренние вызовы к модулю
AUTHOR - Собственно автор модуля
DESCRIPTION - Описание модуля (выводится при вызове wilshell без параметров)
USAGE - Список опций модуля, описание работы модуля (выводится при запуске модуля без параметров)
MODULE\_DEPENDS - если необходимо использовать функции из других модулей
</code></pre></div>

<p>Блок чтения параметров скрипта:</p>

<div class="highlight"><pre><code class="bash">InitOpts <span class="o">()</span> <span class="o">{</span>
    <span class="nv">RUN_FLAG</span><span class="o">=</span>2#000
    <span class="nb">unset </span>OPT_VAL
    <span class="k">while </span><span class="nb">getopts</span> <span class="s2">&quot;:am:v&quot;</span> opt<span class="p">;</span> <span class="k">do</span>
<span class="k">        case</span> <span class="nv">$opt</span> in
            <span class="s1">&#39;a&#39;</span><span class="o">)</span> 
                <span class="nv">RUN_FLAG</span><span class="o">=</span><span class="k">$((</span>RUN_FLAG+2#001<span class="k">))</span><span class="p">;</span>
            <span class="p">;;</span>
            <span class="s1">&#39;m&#39;</span><span class="o">)</span> 
                <span class="nv">OPT_VAL</span><span class="o">=</span><span class="k">${</span><span class="nv">OPTARG</span><span class="k">}</span>
            <span class="p">;;</span>
            <span class="s1">&#39;v&#39;</span><span class="o">)</span> 
                log 3 <span class="s2">&quot;[${MODULE}]&quot;</span><span class="p">;</span>
            <span class="p">;;</span>
            <span class="s1">&#39;?&#39;</span><span class="p">|</span><span class="s1">&#39;:&#39;</span><span class="p">|</span>*<span class="o">)</span> 
                Usage <span class="k">${</span><span class="nv">MODULE</span><span class="k">}</span>
                <span class="nb">exit </span>1
            <span class="p">;;</span>
        <span class="k">esac</span>
<span class="k">    done</span>
</code></pre></div>

<p>Имя функции &quot;InitOpts&quot; обязательное и менять его нельзя. Добавляем нужные аргументы в массив параметров getopts (в данном примере &quot;:am:v&quot; означает, что функция будет ожидать ключ &quot;-m&quot; с аргументами и ключи &quot;-v -a&quot; без аргументов)
В следующем блоке запускается обработчик параметров:</p>

<div class="highlight"><pre><code class="bash">    <span class="k">case</span> <span class="k">${</span><span class="nv">RUN_FLAG</span><span class="k">}</span> in
        <span class="s1">&#39;1&#39;</span><span class="o">)</span>
            LockFun <span class="s2">&quot;${MODULE}-[$(basename ${SCRIPT_RUN})]&quot;</span><span class="p">;</span>
            TestFunction <span class="k">${</span><span class="nv">OPT_VAL</span><span class="k">}</span>
            UnLockFun <span class="s2">&quot;${MODULE}-[$(basename ${SCRIPT_RUN})]&quot;</span><span class="p">;</span>
        <span class="p">;;</span>
        *<span class="o">)</span>
            Usage <span class="k">${</span><span class="nv">MODULE</span><span class="k">}</span>
            <span class="nb">exit </span>1
        <span class="p">;;</span>
    <span class="k">esac</span>
</code></pre></div>

<p>На этом этапе осуществляется вызов функций и основная часть функционала модуля, в зависимости от ключей и параметров могут вызываться различные условия оператора case.</p>

<p>В последнем блоке можно добавлять любые функции, которые будут необходимы в операторе case:</p>

<div class="highlight"><pre><code class="bash">TestFunction <span class="o">()</span> <span class="o">{</span>
    : <span class="k">${</span><span class="nv">1</span><span class="p">?</span><span class="s2">&quot;Not enough parameters. Usage: $FUNCNAME Parameter&quot;</span><span class="k">}</span>
    <span class="nb">echo</span> <span class="k">${</span><span class="nv">1</span><span class="k">:-</span><span class="s2">&quot;This function displays the text&quot;</span><span class="k">}</span>
<span class="o">}</span>
</code></pre></div>

<p>Пример модуля можно посмотреть <a href="https://github.com/wilful/root-shell/blob/master/usr/modules/default.module">тут</a>.</p>

                </section>
            </div>
        </div>
    </dd>
</dl>
<footer class="b-footer">
    <div class="b-footer__row">
        <div class="b-footer__section b-footer__section_type_left">
            wilful.su
        </div>
        <div class="b-footer__section b-footer__section_type_center">
            <a href="http://jabber.srv-nix.com/shell/2014/03/25/wilshell-module.html" target="_blank">Join the discussion</a>
        </div>
        <div class="b-footer__section b-footer__section_type_right">
            <a href=/shell/2014/03/25/wilshell-module.html>&#5123</a>
        </div>
    </div>
    <div class="b-footer__row">
        <div class="b-footer__section b-footer__section_type_left">
        </div>
        <div class="b-footer__section b-footer__section_type_center">
            <a href="/tags/linux.html" rel="tag">linux</a>, <a href="/tags/bash.html" rel="tag">bash</a>, <a href="/tags/shell.html" rel="tag">shell</a>, <a href="/tags/scripts.html" rel="tag">scripts</a>
        </div>
        <div class="b-footer__section b-footer__section_type_right">
        </div>
    </div>
</footer>

  </article>

</div>
</body>
</html>


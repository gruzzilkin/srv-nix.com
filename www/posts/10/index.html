<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>My blog - Сборка ПО из SOURCE rpm пакета на сервере CentOS 6 (nginx+LDAP)</title>
    <link rel="stylesheet" type="text/css" href="/style.css">
  </head>
  <body>
    <span class='pre noprint docinfo top'>[<a href='/' title='Home page'>Home</a>] [<a href='' title='Plaintext version of this document'>txt</a>|<a href='' title='PDF version of this document'>pdf</a>] [<a href='/' title='Site map'>Map</a>]                                                  </span><br />
    <span class='pre noprint docinfo'>             ПЕРВАЯ СТРОКА                                              </span><br />                               
    <span class='pre noprint docinfo'>  ВТОРАЯ                          ШАБЛОН ШАПКИ           STANDARD HEADER</span><br />                               
    <span class='pre noprint docinfo'>        ТРЕТЬЯ                                          <span style='color: #C00;'>ВАЖНОЕ СООБЩЕНИЕ</span></span><br />
    <section class='content'>
      
<div>
  <div>
  Network Working Group                                         A. Semenov
  Posted at:                                February 19, 2014
  Links: <a href="http://habrahabr.ru/post/194482/">habr</a>
  Tags: linux, CentOS
  Test: habr|http://habrahabr.ru/post/194482/ test|http://test.com
  </div>

  <h1>Сборка ПО из SOURCE rpm пакета на сервере CentOS 6 (nginx+LDAP)</h1>

  <article>
      <p><em>Правильная</em> сборка пакетов на сервере под rpm-based системами. Никаких “make install”.  </p>

<!-- more -->

<h2 id="section">Подготовка сервера к сборке</h2>

<ol>
  <li>
    <p>Для начала нужно установить пакеты:</p>

    <pre><code> yum install -y rpmdevtools gcc make yum-utils # Дописать пакеты, необходимые для сборки
</code></pre>
  </li>
  <li>
    <p>Добавляем в систему пользователя, от которого будет выполняться сборка:</p>

    <pre><code> useradd -m rpmbuild
</code></pre>
  </li>
  <li>
    <p>Готовим дерево сборки для пакетов:</p>

    <pre><code> sudo -u rpmbuild -i
 rpmdev-setuptree
 tree -L 1 rpmbuild/
 rpmbuild/
 ├── BUILD # Директория сборки
 ├── BUILDROOT # Директория сборки
 ├── RPMS # Содержит готовые rpm-пакеты
 ├── SOURCES # Исходные коды
 ├── SPECS # Файлы описаний (SPEC)
 └── SRPMS # Исходные srpm-пакеты
</code></pre>
  </li>
</ol>

<h2 id="nginxldap">Сборка собственного пакета на примере nginx+ldap</h2>

<p><strong>внимание: не выполняй сборку от имени root!!!</strong></p>

<ol>
  <li>
    <p>Все операции выполняются от пользователя rpmbuild (чтобы не нанести вред системе)</p>

    <pre><code> sudo -u rpmbuild -i 
</code></pre>
  </li>
  <li>
    <p>Качаем необходимые исходники/пачи/файлы
 Для nginx я взял SRC пакет из официального 
 <a href="http://wiki.nginx.org/Install#Official_Red_Hat.2FCentOS_packages">репозитория nginx</a> для CentOS. 
 Модуль для авторизации с официального <a href="https://github.com/kvspb/nginx-auth-ldap">репозитория GIT</a> </p>

    <pre><code> cd ~/rpmbuild/SRPMS/
 VERSION_NG="1.2.5"
 wget -nd -r -l 1 -A "nginx-${VERSION_NG}*src.rpm"  http://nginx.org/packages/centos/6/SRPMS/ 2&gt;/dev/null
 cd ~/rpmbuild/SOURCES/
 git clone https://github.com/kvspb/nginx-auth-ldap 
</code></pre>
  </li>
  <li>
    <p>Устанавливаем необходимые для сборки пакеты</p>

    <pre><code> yum-builddep nginx-${VERSION_NG}-*.ngx.src.rpm --nogpgcheck 
</code></pre>
  </li>
  <li>
    <p>Устанавливаем пакет (он будет распакован в предварительно подготовленное дерево 
 каталогов /home/rpmbuild/rpmbuild)</p>

    <pre><code> rpm -ivh nginx-${VERSION_NG}-*.ngx.src.rpm`
</code></pre>
  </li>
  <li>
    <p>Вносим изменения в файл сборки</p>

    <pre><code> vim ~/rpmbuild/SPECS/nginx.spec
</code></pre>
  </li>
  <li>
    <p>Меняем в строке номер релиза (чтобы пакет обновился при установке)</p>

    <pre><code> ---
 Release: 4%{?dist}.wil
 ---  
</code></pre>

    <p><em>ЗАМЕЧАНИЕ:</em> Я также указал суффикс wil для уникальности пакета </p>
  </li>
  <li>
    <p>Добавляем строку описания источника с исходными текстами модуля</p>

    <pre><code> ---
 Source1001: nginx-auth-ldap
 --- 
</code></pre>
  </li>
  <li>
    <p>Добавляем модуль в параметры сборки nginx (так же как при обычной сборке)</p>

    <pre><code> ---
 ./configure \
 --add-module=%{SOURCE1001} \
 ---  
</code></pre>

    <p><em>ЗАМЕЧАНИЕ:</em> Возможно потребуется добавить параметры сборки дважды для debug и original версий пакета </p>
  </li>
  <li>
    <p>Теперь можем приступить к сборке нашего пакета:</p>

    <pre><code> cd ~/rpmbuild/SPECS/
 rpmbuild -bb nginx.spec 
</code></pre>
  </li>
  <li>
    <p>После сборки будет примерно следующая запись:</p>

    <pre><code>Записан: /home/rpmbuild/rpmbuild/RPMS/x86_64/nginx-1.bla.bla.rpm
Записан: /home/rpmbuild/rpmbuild/RPMS/x86_64/nginx-debug-1.bla.bla.rpm 
</code></pre>
  </li>
  <li>Это наши готовые для установки пакеты, теперь можно установить через rpm или 
 использовать локальный репозиторий для установки через yum</li>
  <li>
    <p>Так же рекомендую создать srpm-пакет, чтобы не потерять ваши изменения и можно было 
 развернуть его на любом сервере</p>

    <pre><code>rpmbuild -bs nginx.spec
</code></pre>
  </li>
  <li>
    <p>Файл будет тут</p>

    <pre><code>Записан: /home/rpmbuild/rpmbuild/SRPMS/nginx-1.bla.bla.src.rpm
</code></pre>
  </li>
  <li>PROFIT?</li>
</ol>

  </article>
  </pre><!--NewPage--><pre class='newpage'><a  href="#" class="invisible"> </a>
  <span class="grey"><a href="/posts/10/">Сборка ПО из SOURCE rpm пакета на сервере CentOS 6 (nginx+LDAP)</a></span>
</div>

    </section>
  </body>
</html>



<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="google-site-verification" content="zrEDTiP0xgJYfIhexhD8C_CBtEQQrJa1fnOmXrzyhVM" />
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Настройка сервера и клиента OpenLDAP на использование TLS/SSL соединений под CentOS 6</title>
    <meta name="viewport" content="width=device-width">
    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
<div class="b-canvas">
    <nav class="b-menu b-menu_type_inline b-menu_viewtype_square-brackets">
        <ul class="b-menu__list">
            <li class="b-menu__item"><a href="/" class="b-menu__item-text b-link"><span class="b-link__text">SRV-NIX.COM</span></a></li>
            <li class="b-menu__item"><a href="http://srv-nix.com/tags.html" class="b-menu__item-text b-link"><span class="b-link__text">Tags</span></a></li>
        </ul>
    </nav>

  <article class="b-document">
      <header class="b-document-header">
    <div class="b-document-header__section">
        Authtor:<br/>
        Posted at:<br/>
    </div>
    <div class="b-document-header__section">
        A. Semenov<br/>
        21 Mar 2014<br/>
    </div>
</header>
<h4 class="b-document-title">Настройка сервера и клиента OpenLDAP на использование TLS/SSL соединений под CentOS 6</h1>
<div class="b-document-body">
    <section>
        <p>Я не буду вникать в детали генерации сертификатов, не буду детально рассказывать про параметры в конфигурационных файлах. Эта заметка предназначена для быстрой настройки подключения и демонстрации того, что можно использовать стандартные средства консоли без рукоблудства в конфигах. </p>

<!--more-->

<p>Во-первых, нужно сгенерировать свой сертификат и подписать с помощью него клиентский ключ.</p>

<p>Во-вторых, добавить сертификаты в основную конфигурацию slapd и размножить на клиентских машинах с помощью authconfig и любого веб-сервера.
На клиентах будет использоваться демон sssd, который позволяет службам обращаться не напрямую к серверу, а через демона. Тем самым обеспечивается быстродействие при использовании кэша и возможность автономной работы.</p>

<p>Настройка сервера
И так, переходим в каталог в котором будут храниться наши сертификаты:</p>

<div class="highlight"><pre><code class="bash"><span class="nb">cd</span> /etc/openldap/cacerts/
</code></pre></div>

<p>И генерируем сертификат</p>

<div class="highlight"><pre><code class="bash">openssl req -x509 -nodes -days 3650 -newkey rsa:2048 -keyout keys/ldapskey.pem -out ldapscert.pem
</code></pre></div>

<p>Замечание: в поле hostname нужно вводить реальное имя сервера OpenLDAP, по которому будет доступен сервер
Ключ ldapscert.pem необходимо разместить на веб-сервере, доступ к которому будут иметь все клиентские машины, например так: http://key.server.ltd/ldapscert.pem
Для надежности задаем права доступа только для пользователя ldap</p>

<div class="highlight"><pre><code class="bash">chown -R ldap:ldap /etc/openldap/cacerts/*
chmod 0400 /etc/openldap/cacerts/keys/ldapskey.pem
</code></pre></div>

<p>Вносим изменения для демона slapd (я всё еще использую устаревший метод правки конфигурации через /etc/openldap/slapd.conf)</p>

<div class="highlight"><pre><code class="bash">---
TLSCertificateFile      /etc/openldap/cacerts/ldapscert.pem
TLSCertificateKeyFile   /etc/openldap/cacerts/keys/ldapskey.pem
TLSCipherSuite TLSv1+RSA:!NULL
---
</code></pre></div>

<p>Следующим шагом указываем серверу слушать только ldaps порт, и принимать соединения только через него.
Для этого используется файл /etc/sysconfig/ldap</p>

<div class="highlight"><pre><code class="bash">---
<span class="c">#   yes/no, default: yes</span>
<span class="nv">SLAPD_LDAP</span><span class="o">=</span>no

<span class="c"># Run slapd with -h &quot;... ldapi:/// ...&quot;</span>
<span class="c">#   yes/no, default: yes</span>
<span class="nv">SLAPD_LDAPI</span><span class="o">=</span>no

<span class="c"># Run slapd with -h &quot;... ldaps:/// ...&quot;</span>
<span class="c">#   yes/no, default: no</span>
<span class="nv">SLAPD_LDAPS</span><span class="o">=</span>yes
---
</code></pre></div>

<p>Перезапускаем сервер</p>

<div class="highlight"><pre><code class="bash">/etc/init.d/slapd stop
rm -rf /etc/openldap/slapd.d/*
sudo -u ldap slaptest -f slapd.conf -F slapd.d/
/etc/init.d/slapd restart
</code></pre></div>

<p>Замечание: slaptest я запускаю для того, чтобы новая форма конфигурации так же была актуальной.
На этом настройка сервера закончена. Дополнительно нужно проверить доступность сервера по 636 порту.
Настройка клиента
Для конфигурации клиента будем использовать утилиту authconfig</p>

<div class="highlight"><pre><code class="bash"><span class="nv">SERVER</span><span class="o">=</span><span class="s2">&quot;ldaps://ldap.server.ltd&quot;</span> <span class="c"># Сервер для подключения и он же hostname при генерации сертификата</span>
<span class="nv">ROOTDN</span><span class="o">=</span><span class="s2">&quot;o=server,c=ltd&quot;</span> <span class="c"># Корневая запись</span>
<span class="nv">CERTURL</span><span class="o">=</span><span class="s2">&quot;http://key.server.ltd/ldapscert.pem&quot;</span> <span class="c"># Адрес веб-сервера на котором лежит наш подписанный клиентский ключик</span>
authconfig --ldapserver<span class="o">=</span><span class="nv">$SERVER</span> --ldapbasedn<span class="o">=</span><span class="nv">$ROOTDN</span> --ldaploadcacert<span class="o">=</span><span class="nv">$CERTURL</span> --enablemkhomedir --updateall --enablesssd --enablesssdauth --enableldap --enableldapauth --disablenis --disablekrb5 --enableldaptls --enableldapstarttls
</code></pre></div>

<p>Настройка клиента окончена, можно проверить соединение с помощью</p>

<div class="highlight"><pre><code class="bash">id user_name
ldapsearch -v -x -b <span class="nv">$ROOTDN</span>
ldapsearch -d 1 -v -H ldaps://<span class="nv">$SERVER</span>
</code></pre></div>

    </section>
</div>
<footer class="b-footer">
    <div class="b-footer__row">
        <div class="b-footer__section b-footer__section_type_left">
            wilful.su
        </div>
        <div class="b-footer__section b-footer__section_type_center">
            Tags
        </div>
        <div class="b-footer__section b-footer__section_type_right">
            <a href=/linux/2014/03/21/openldap-tls.html>&#5123</a>
        </div>
    </div>
    <div class="b-footer__row">
        <div class="b-footer__section b-footer__section_type_left">
        </div>
        <div class="b-footer__section b-footer__section_type_center">
            <a href="/tags/linux.html" rel="tag">linux</a>, <a href="/tags/openldap.html" rel="tag">openldap</a>, <a href="/tags/TLS.html" rel="tag">TLS</a>
        </div>
        <div class="b-footer__section b-footer__section_type_right">
        </div>
    </div>
</footer>

  </article>

</div>
</body>
</html>


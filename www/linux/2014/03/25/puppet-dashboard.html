<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="google-site-verification" content="zrEDTiP0xgJYfIhexhD8C_CBtEQQrJa1fnOmXrzyhVM" />
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Puppet dashboard [pending tasks] - накопил уже мужик!</title>
    <meta name="viewport" content="width=device-width">
    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
<div class="b-canvas">
    <nav class="b-menu b-menu_type_inline b-menu_viewtype_square-brackets">
        <ul class="b-menu__list">
            <li class="b-menu__item"><a href="/" class="b-menu__item-text b-link"><span class="b-link__text">SRV-NIX.COM</span></a></li>
            <li class="b-menu__item"><a href="http://srv-nix.com/tags.html" class="b-menu__item-text b-link"><span class="b-link__text">Tags</span></a></li>
            <li class="b-menu__item"><a href="https://www.google.ru/search?q=google.com&oq=google.com&#newwindow=1&q=site:srv-nix.com" target="_blank" class="b-menu__item-text b-link"><span class="b-link__text">Search</span></a></li>
        </ul>
    </nav>

  <article class="b-document">
      <header class="b-document-header">
    <div class="b-document-header__section">
        Authtor:<br/>
        Posted at:<br/>
    </div>
    <div class="b-document-header__section">
        A. Semenov<br/>
        25 Mar 2014<br/>
    </div>
</header>
<dl class="b-document-section">
    <dt class="b-document-section__title">
        NAME
    </dt>
    <dd class="b-document-section__body b-pure-content">
                <h1>Puppet dashboard [pending tasks] - накопил уже мужик!</h1>
    </dd>
</dl>
<dl class="b-document-section">
    <dt class="b-document-section__title">
        Description
    </dt>
    <dd class="b-document-section__body b-pure-content">
        <div class="b-document-body">
            <div class="b-pure-content">
                <section>
                    <p>Puppet Dashboard состоит из двух частей - это собственно рельсовый веб движок (puppet-dashboard для CentOS) и демон собирающий статистику puppet-dashboard-worker. Со вторым у меня получилась неприятная ситуация: он просто перестал обрабатывать поступающие запросы на обновление данных. Как выяснилось позже - это происходило из-за одного проблемного запроса, который не позволял демону пройти до конца очереди. На тот момент очередь уже состояла из более чем 6000 запросов.</p>

<!--more-->

<p>Итак, диагностика проблемы</p>

<ul>
<li>На вебинтерфейсе скапливаются запросы &quot;pending tasks&quot;</li>
<li>Статус серверов стал &quot;Unresponsive&quot;</li>
<li>Ощущение, что что-то не так...</li>
</ul>

<p>Логи для коллектора репортов находятся в /usr/share/puppet-dashboard-worker/log. Мне удалось разглядеть в них ошибку содержащую примерно такой текст:</p>

<div class="highlight"><pre><code class="ruby"><span class="no">ActiveRecord</span><span class="o">::</span><span class="ss">StatementInvalid</span><span class="p">:</span> <span class="no">Mysql</span><span class="o">::</span><span class="ss">Error</span><span class="p">:</span> <span class="no">Data</span> <span class="n">too</span> <span class="n">long</span> <span class="k">for</span> <span class="n">column</span> <span class="s1">&#39;details&#39;</span> <span class="n">at</span> <span class="n">row</span> <span class="mi">1</span><span class="p">:</span> <span class="no">INSERT</span> <span class="no">INTO</span> <span class="sb">`delayed_job_failures`</span>
</code></pre></div>

<p>Запрос который необходимо было выполнить превышал допустимый размер в поле таблицы. Для исправления воспользовался следующим запросом:</p>

<div class="highlight"><pre><code class="mysql"><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">REPORT_LOGS</span> <span class="k">CHANGE</span> <span class="k">COLUMN</span> <span class="n">MESSAGE</span> <span class="n">MESSAGE</span> <span class="kt">VARCHAR</span><span class="p">(</span><span class="mi">65536</span><span class="p">);</span>
</code></pre></div>

<p>Для чистоты эксперимента я почистил всю очередь запросов:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">service</span> <span class="n">puppet</span><span class="o">-</span><span class="n">dashboard</span><span class="o">-</span><span class="n">workers</span> <span class="n">stop</span>
<span class="n">cd</span> <span class="sr">/usr/s</span><span class="n">hare</span><span class="o">/</span><span class="n">puppet</span><span class="o">-</span><span class="n">dashboard</span>
<span class="n">rm</span> <span class="o">-</span><span class="n">f</span> <span class="n">spool</span><span class="o">/*</span>
<span class="n">rake</span> <span class="ss">jobs</span><span class="p">:</span><span class="n">clear</span> <span class="no">RAILS_ENV</span><span class="o">=</span><span class="n">production</span>
<span class="n">service</span> <span class="n">puppet</span><span class="o">-</span><span class="n">dashboard</span><span class="o">-</span><span class="n">workers</span> <span class="n">start</span>
</code></pre></div>

                </section>
            </div>
        </div>
    </dd>
</dl>
<footer class="b-footer">
    <div class="b-footer__row">
        <div class="b-footer__section b-footer__section_type_left">
            wilful.su
        </div>
        <div class="b-footer__section b-footer__section_type_center">
            <a href="http://jabber.srv-nix.com/linux/2014/03/25/puppet-dashboard.html" target="_blank">Join the discussion</a>
        </div>
        <div class="b-footer__section b-footer__section_type_right">
            <a href=/linux/2014/03/25/puppet-dashboard.html>&#5123</a>
        </div>
    </div>
    <div class="b-footer__row">
        <div class="b-footer__section b-footer__section_type_left">
        </div>
        <div class="b-footer__section b-footer__section_type_center">
            <a href="/tags/puppet.html" rel="tag">puppet</a>, <a href="/tags/linux.html" rel="tag">linux</a>, <a href="/tags/error.html" rel="tag">error</a>
        </div>
        <div class="b-footer__section b-footer__section_type_right">
        </div>
    </div>
</footer>

  </article>

</div>
</body>
</html>

